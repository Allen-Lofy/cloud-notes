# Cloud Notes 云笔记 - 功能实现规划文档

## 项目概述

基于 Next.js + Supabase 的云笔记应用，结合 Obsidian 风格的文件管理和团队协作功能。

## 技术栈选择

- **前端**: Next.js 14+ (App Router)
- **数据库**: Supabase (PostgreSQL)
- **认证**: Supabase Auth
- **文件存储**: Supabase Storage
- **UI组件**: shadcn/ui + TailwindCSS
- **状态管理**: Zustand
- **Markdown编辑**: Monaco Editor 或 CodeMirror
- **Markdown渲染**: react-markdown + remark-math + rehype-katex
- **PDF导出**: jsPDF 或 react-to-pdf
- **文档预览**: react-pdf, mammoth.js (docx), file-saver

## 核心功能模块

### 1. 用户认证系统

**功能需求:**
- 用户注册（邮箱+密码，无需验证）
- 用户登录
- 用户登出
- 会话保持

**实现方案:**
- 使用 Supabase Auth 的邮箱密码认证
- 创建认证中间件保护路由
- 注册后自动创建用户profile记录
- 实现认证状态的全局管理

### 2. 文件系统管理

**功能需求:**
- 类似 Obsidian 的目录树结构
- 创建/删除/重命名文件夹
- 创建/删除/重命名文件
- 拖拽移动文件和文件夹
- 文件夹层级展开/收缩

**数据库设计:**
- folders表：支持父子关系的文件夹结构
- files表：关联用户和文件夹，存储文件元数据

**实现方案:**
- 使用递归组件渲染文件树
- 实现拖拽API进行文件移动
- 使用Context菜单提供右键操作
- 面包屑导航显示当前路径

### 3. Markdown编辑器

**功能需求:**
- 实时编辑Markdown文件
- 分屏预览（编辑/预览模式切换）
- LaTeX数学公式渲染
- 特别处理 `\\` 换行转义
- 支持完整Markdown语法
- 编辑器快捷键支持

**实现方案:**
- 集成Monaco Editor提供代码编辑体验
- 使用react-markdown + remark-math + rehype-katex渲染
- 自定义插件处理双反斜杠换行
- 实现快捷键监听器（Ctrl+B加粗、Ctrl+Z撤销等）
- 自动保存功能，防止数据丢失

### 4. 文件上传与管理

**功能需求:**
- 支持多文件上传
- 文件类型：PDF、图片、DOCX、ZIP等
- 文件大小限制和类型验证
- 上传进度显示
- 批量文件操作

**实现方案:**
- 使用Supabase Storage存储文件
- 创建文件上传组件支持拖拽上传
- 实现文件类型检测和大小验证
- 存储文件元数据到数据库
- 支持文件批量选择和操作

### 5. 文件预览系统

**功能需求:**
- PDF文件在线预览
- 图片文件预览（支持缩放）
- DOCX文档预览
- 其他文件显示文件信息
- 不支持预览的文件提供下载

**实现方案:**
- PDF: 使用react-pdf组件
- 图片: 原生img标签 + 图片查看器
- DOCX: 使用mammoth.js转换为HTML预览
- ZIP等文件: 显示文件信息和下载按钮
- 创建通用文件预览组件

### 6. 文件下载功能

**功能需求:**
- 单文件下载
- 多文件批量下载（打包为ZIP）
- 文件夹整体下载
- 下载进度提示

**实现方案:**
- 单文件: 直接从Supabase Storage下载
- 批量下载: 使用JSZip打包多个文件
- 使用file-saver库触发浏览器下载
- 实现下载队列和进度管理

### 7. PDF导出功能

**功能需求:**
- Markdown文件导出为PDF
- 保持格式和LaTeX公式渲染
- 自定义PDF样式和页面设置

**实现方案:**
- 使用puppeteer或jsPDF生成PDF
- 先将Markdown渲染为HTML
- 应用CSS样式确保打印友好
- 处理分页和页面布局

### 8. 用户设置界面

**功能需求:**
- 修改个人信息（用户名、显示名称）
- 修改密码
- 上传/更换头像
- 一键导出所有文件
- 账户设置和偏好设置

**数据库设计:**
- profiles表存储用户扩展信息
- 头像存储在Supabase Storage

**实现方案:**
- 创建设置页面和表单组件
- 实现头像上传和裁剪功能
- 密码修改使用Supabase Auth API
- 导出功能打包用户所有文件

### 9. 管理员面板

**功能需求:**
- 用户管理（查看、删除用户）
- 系统统计信息
- 导出所有数据库数据
- 系统设置和配置

**实现方案:**
- 基于角色的权限控制（RLS策略）
- 创建管理员专用路由和组件
- 实现数据导出功能（JSON/CSV格式）
- 用户操作日志记录

### 10. 社交分享空间

**功能需求:**
- 用户可以公开分享笔记
- 分享时可添加标题、描述、标签
- 其他用户可以浏览、点赞分享的内容
- 分享内容的搜索和分类

**数据库设计:**
- shares表：存储分享的笔记信息
- likes表：记录用户点赞
- 添加标签和分类字段

**实现方案:**
- 创建分享发布界面
- 实现公共分享广场页面
- 搜索和筛选功能
- 点赞和社交互动功能

## UI设计规范

**整体风格:**
- 简约现代设计风格
- 白色条纹背景
- 使用shadcn/ui组件保持一致性
- 响应式设计支持移动端

**布局结构:**
- 左侧：文件树导航
- 中间：主编辑/预览区域
- 右侧：文件信息或预览面板（可收缩）
- 顶部：工具栏和用户菜单

**色彩方案:**
- 主色调：简洁的蓝灰色系
- 背景：白色条纹纹理
- 强调色：用于按钮和链接
- 确保足够的对比度和可访问性

## 性能优化考虑

**前端优化:**
- 文件树虚拟化（处理大量文件）
- Markdown编辑器防抖保存
- 图片懒加载和压缩
- 代码分割和懒加载路由

**后端优化:**
- 数据库索引优化
- 文件上传分片处理
- 缓存策略（Redis可选）
- CDN加速文件访问

## 安全性考虑

**数据安全:**
- Supabase RLS策略确保数据隔离
- 文件访问权限控制
- 敏感操作的身份验证
- 防止SQL注入和XSS攻击

**文件安全:**
- 文件类型白名单验证
- 文件大小限制
- 恶意文件检测
- 存储加密

## 部署和运维

**部署方案:**
- Vercel托管Next.js应用
- Supabase管理数据库和存储
- 环境变量管理敏感信息
- 自动化部署和版本控制

**监控和日志:**
- 错误追踪和性能监控
- 用户行为分析
- 系统健康检查
- 备份策略

## 开发里程碑

**Phase 1 - 基础功能**
- 用户认证系统
- 基本文件管理
- Markdown编辑器
- 文件上传预览

**Phase 2 - 进阶功能**
- PDF导出
- 批量操作
- 用户设置
- 性能优化

**Phase 3 - 协作功能**
- 社交分享空间
- 管理员面板
- 高级搜索
- 团队协作功能

这份文档为Cloud Notes项目提供了完整的功能规划和实现思路，可以作为Claude Code开发的参考依据。